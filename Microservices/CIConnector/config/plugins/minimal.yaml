name: minimal
defaults:
  COMPOSE_FILE: docker-compose.yml

github_actions:
  name: "MobileSec-MS Smoke"
  on:
    push:
      branches: ["main"]
  jobs:
    smoke:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v4
        - run: docker compose -f ${COMPOSE_FILE} up -d --build
        - run: sleep 5
        - run: curl -fsS http://localhost:8004/health
        - run: docker compose -f ${COMPOSE_FILE} down -v

gitlab_ci:
  stages: [smoke]
  smoke:
    stage: smoke
    image: docker:27
    services: [docker:27-dind]
    variables:
      DOCKER_HOST: tcp://docker:2375
      DOCKER_TLS_CERTDIR: ""
    script:
      - docker compose -f ${COMPOSE_FILE} up -d --build
      - sleep 5
      - curl -fsS http://localhost:8004/health
      - docker compose -f ${COMPOSE_FILE} down -v
